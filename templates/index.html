<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>YouTube Downloader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --panel:#11131a; --muted:#98a0b3; --accent1:#2dd4bf; --accent2:#22c55e; --card:#151721; color-scheme: dark; }
    body { margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#e6eef6; }
    .container { max-width:920px; margin:28px auto; padding:20px; }
    h1 { margin:0 0 14px 0; font-size:20px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"], select { background:var(--panel); border:1px solid #222632; color:inherit; padding:10px 12px; border-radius:8px; min-width:220px; }
    button { background:linear-gradient(90deg,var(--accent1),var(--accent2)); border:none; color:#071019; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:transparent; border:1px solid #2b3242; color:var(--muted); }
    .small { font-size:13px; padding:8px 10px; border-radius:6px; }
    .controls { margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .panel { background:var(--card); border:1px solid #1e222b; padding:14px; border-radius:10px; margin-top:14px; }
    .label { font-size:13px; color:var(--muted); margin-bottom:6px; }
    .progress { background:#0b0d11; border:1px solid #222632; border-radius:8px; height:22px; position:relative; overflow:hidden; }
    .bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); transition:width .35s ease; }
    .percent { position:absolute; left:50%; top:0; transform:translateX(-50%); font-size:12px; font-weight:700; color:#071019; line-height:22px; }
    .metrics { display:flex; gap:12px; margin-top:8px; font-size:13px; color:var(--muted); }
    .metric { min-width:90px; }
    .thumb { max-width:220px; border-radius:8px; margin-top:12px; display:none; border:1px solid #222632; }
    .info-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
    .toggles { display:flex; gap:10px; align-items:center; font-size:13px; color:var(--muted); }
    .note { font-size:13px; color:var(--muted); margin-top:8px; }
    .error { margin-top:8px; background:#2b1616; color:#ffd6d6; padding:8px 10px; border-radius:8px; display:none; }
    #complete { margin-top:10px; color:var(--accent2); font-weight:700; }
    .spinner { width:14px; height:14px; border-radius:50%; border:2px solid #22313a; border-top:2px solid var(--accent2); display:inline-block; animation:spin .9s linear infinite; vertical-align:middle; margin-right:8px;}
    @keyframes spin { to { transform:rotate(360deg); } }

    /* NEW: 3-button selector (Auto / Force MP3 / Lossless) for right column */
    .seg-btns { display:flex; gap:8px; margin-top:10px; width:100%; }
    .seg-btn { flex:1; padding:8px 10px; border-radius:8px; border:1px solid #222b2f; background:linear-gradient(180deg,#0b1114,#071011); color:#cfeee2; font-weight:700; cursor:pointer; font-size:13px; }
    .seg-btn.inactive { color:#98a0b3; background:linear-gradient(180deg,#0b0f14,#071012); border-color:#222b2e; box-shadow:none; }
    .seg-btn.active { color:#041005; background:linear-gradient(90deg,#8ef0c8,#22c55e); border-color:transparent; box-shadow:0 8px 22px rgba(34,197,94,0.18); }
    .seg-desc { margin-top:8px; color:var(--muted); font-size:13px; text-align:center; }
    @media (max-width:720px) {
      .info-row { flex-direction:column; }
      .thumb { margin:0 auto 10px auto; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>YouTube Downloader</h1>

    <div class="panel">
      <div class="row">
        <input id="url" type="text" placeholder="Paste YouTube URL" />
        <button id="fetch-btn" onclick="fetchInfo()">Fetch info</button>
      </div>

      <div id="fetched-area" style="display:none; margin-top:12px;">
        <div class="info-row">
          <div style="flex:1;">
            <div class="label">Video formats</div>
            <select id="video"></select>
            <div id="video-size-preview" class="note"></div>
          </div>

          <div style="flex:1;">
            <div class="label">Audio formats</div>
            <select id="audio"></select>
            <div id="audio-size-preview" class="note"></div>
          </div>

          <div style="min-width:180px;">
            <!-- Thumbnail (top of right block) -->
            <img id="thumbnail" class="thumb" alt="thumb" />
            <div id="format-label" class="note">Format auto-select: based on bitrate.</div>

            <!-- REPLACED: checkboxes -> 3-button single-choice selector -->
            <div class="seg-btns" role="tablist" aria-label="Format mode">
              <button id="seg-auto" class="seg-btn">Auto</button>
              <button id="seg-mp3" class="seg-btn">Force MP3</button>
              <button id="seg-lossless" class="seg-btn">Lossless</button>
            </div>
            <div id="seg-desc" class="seg-desc">Auto ‚Äî backend chooses the best format based on bitrate.</div>
          </div>
        </div>

        <div class="controls">
          <button id="audio-btn" onclick="startAudio()" class="small">Download Audio</button>
          <button id="video-btn" onclick="startVideo()" class="small">Download Video</button>
          <button id="cancel-btn" onclick="cancelDownload()" class="small secondary" style="display:none;">Cancel</button>
          <button id="reset-btn" onclick="resetUI()" class="small secondary" style="display:none;">Reset</button>
        </div>
      </div>

      <div id="status" class="note" style="margin-top:10px;">‚è≥ Waiting for input‚Ä¶</div>
      <div id="error" class="error"></div>
      <div id="complete"></div>
    </div>

    <div id="progress-section" class="panel" style="display:none;">
      <div id="video-section" style="display:none;">
        <h3 style="margin:0 0 8px 0;">Video</h3>
        <div class="progress"><div id="video-bar" class="bar"></div><div id="video-percent" class="percent">0%</div></div>
        <div class="metrics">
          <div id="video-eta" class="metric">ETA: ‚Äî</div>
          <div id="video-speed" class="metric">Speed: ‚Äî</div>
          <div id="video-size" class="metric">Size: ‚Äî</div>
          <div id="video-status" class="metric">Status: ‚Äî</div>
        </div>
      </div>

      <div id="audio-section" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px 0;">Audio</h3>
        <div class="progress"><div id="audio-bar" class="bar"></div><div id="audio-percent" class="percent">0%</div></div>
        <div class="metrics">
          <div id="audio-eta" class="metric">ETA: ‚Äî</div>
          <div id="audio-speed" class="metric">Speed: ‚Äî</div>
          <div id="audio-size" class="metric">Size: ‚Äî</div>
          <div id="audio-status" class="metric">Status: ‚Äî</div>
        </div>
      </div>

      <div id="merge-section" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px 0;">Merge</h3>
        <div class="progress"><div id="merge-bar" class="bar"></div><div id="merge-percent" class="percent">0%</div></div>
        <div class="metrics">
          <div id="merge-eta" class="metric">ETA: ‚Äî</div>
          <div id="merge-speed" class="metric">Speed: ‚Äî</div>
          <div id="merge-size" class="metric">Size: ‚Äî</div>
          <div id="merge-status" class="metric">Status: ‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let poller;
    let audioFormats = [];
    let videoFormats = [];

    function el(id){ return document.getElementById(id); }
    function setText(id, t){ const n=el(id); if(n) n.textContent = t; }
    function getVal(id){ const n=el(id); return n? n.value : ""; }
    function fmtSize(bytes){
      if(!bytes) return "‚Äî";
      const b = Number(bytes);
      if(isNaN(b)) return "‚Äî";
      const kb = b/1024, mb = kb/1024, gb = mb/1024;
      if(gb>=1) return `${gb.toFixed(2)} GB`;
      if(mb>=1) return `${mb.toFixed(1)} MB`;
      return `${Math.round(kb)} KB`;
    }

    // NEW: segmented 3-button selector logic
    // mode: 0 = Auto, 1 = Force MP3, 2 = Lossless
    (function(){
      let mode = 0;
      const ids = ['seg-auto','seg-mp3','seg-lossless'];
      const desc = [
        'Auto ‚Äî backend chooses the best format based on bitrate.',
        'Force MP3 ‚Äî convert/force MP3 output.',
        'Lossless ‚Äî prefer lossless output (FLAC).'
      ];

      function setMode(m){
        mode = m;
        ids.forEach((id, i) => {
          const b = el(id);
          if(!b) return;
          if(i === m){ b.classList.add('active'); b.classList.remove('inactive'); b.setAttribute('aria-pressed','true'); }
          else { b.classList.add('inactive'); b.classList.remove('active'); b.setAttribute('aria-pressed','false'); }
        });
        setText('seg-desc', desc[m]);
      }

      ids.forEach((id, i) => {
        const b = el(id);
        if(!b) return;
        b.addEventListener('click', () => setMode(i));
      });

      // expose getter for integration with startAudio()
      window.getFormatMode = () => mode;

      // default: Auto (0). If you want Force MP3 default, call setMode(1) instead.
      setMode(0);
    })();

    // Fetch video/audio format info
    function fetchInfo(){
      const url = getVal("url").trim();
      if(!url){ setText("status","Please paste a valid URL."); return; }
      setText("status","Fetching metadata‚Ä¶");
      fetch("/fetch", { method:"POST", body: JSON.stringify({url}), headers: {"Content-Type":"application/json"} })
        .then(r => r.json())
        .then(()=> fetch("/info"))
        .then(r => r.json())
        .then(info => {
          audioFormats = info.audio_formats || [];
          videoFormats = info.video_formats || [];
          populateDropdowns(info);
          el("fetched-area").style.display = "block";
          el("progress-section").style.display = "none";
          setText("status", "Ready ‚Äî choose formats or download directly.");
          if(info.thumbnail){ el("thumbnail").src = info.thumbnail; el("thumbnail").style.display = "block"; }
        })
        .catch(e => {
          console.error(e);
          setText("status", "Failed to fetch info.");
        });
    }

    // populateDropdowns: video options + audio options include abr, acodec, ext, size inline
    function populateDropdowns(info){
      const vsel = el("video"); const asel = el("audio");
      vsel.innerHTML = ""; asel.innerHTML = "";
      videoFormats = info.video_formats || [];
      audioFormats = info.audio_formats || [];

      // Video options: show resolution/ext/estimated size inline in option
      videoFormats.forEach(f => {
        const opt = document.createElement("option");
        const res = f.resolution || (f.height ? `${f.height}p` : f.ext || "");
        const sizeText = f.size ? ` ‚Äî ${fmtSize(f.size)}` : "";
        opt.value = f.format_id;
        opt.text = `${res} ‚Äî ${f.ext}${sizeText}`;
        opt.dataset.size = f.size || "";
        vsel.appendChild(opt);
      });

      // Audio options: show abr / acodec / ext / estimated size inline in option
      audioFormats.forEach(f => {
        const abrText = f.abr ? `${f.abr}kbps` : "best";
        const codecText = f.acodec ? `${f.acodec}` : "";
        const extText = f.ext ? `${f.ext}` : "";
        const sizeText = f.filesize ? ` ‚Äî ${fmtSize(f.filesize)}` : "";
        const parts = [abrText, codecText, extText].filter(Boolean).join(" ‚Äî ");
        const opt = document.createElement("option");
        opt.value = f.format_id;
        opt.text = `${parts}${sizeText}`;
        opt.dataset.filesize = f.filesize || "";
        asel.appendChild(opt);
      });

      // select best defaults
      if(vsel.options.length) vsel.selectedIndex = 0;
      if(asel.options.length) asel.selectedIndex = 0;

      // keep size preview boxes for accessibility/summary
      updateSizePreviews();
      el("audio").addEventListener("change", updateSizePreviews);
      el("video").addEventListener("change", updateSizePreviews);

      // update format-label based on top audio format
      if(audioFormats.length){
        const top = audioFormats[0];
        const abr = top.abr || "best";
        let format = "ogg";
        if(abr >= 256) format = "flac";
        else if(abr >= 192) format = "mp3";
        setText("format-label", `Auto-selected format: ${format} (${abr}kbps)`);
      } else {
        setText("format-label","Format auto-select: based on bitrate.");
      }
    }

    function updateSizePreviews(){
      const aSel = el("audio").value;
      const vSel = el("video").value;
      const aInfo = audioFormats.find(f => f.format_id == aSel) || {};
      const vInfo = videoFormats.find(f => f.format_id == vSel) || {};
      setText("audio-size-preview", aInfo.filesize ? `Estimated size: ${fmtSize(aInfo.filesize)}` : "");
      setText("video-size-preview", vInfo.size ? `Estimated size: ${fmtSize(vInfo.size)}` : "");
    }

    // Start audio-only download (reads 3-button selector)
    function startAudio(){
      resetProgressUI();
      showSpinner("audio");
      el("audio-section").style.display = "block";
      el("video-section").style.display = "none";
      el("merge-section").style.display = "none";
      el("progress-section").style.display = "block";
      el("cancel-btn").style.display = "inline-block";
      el("reset-btn").style.display = "inline-block";

      const mode = window.getFormatMode ? window.getFormatMode() : 0;
      const payload = {
        url: getVal("url"),
        audio_id: getVal("audio") || null,
        force_mp3: mode === 1,
        lossless_only: mode === 2
      };

      fetch("/download_audio", { method:"POST", body: JSON.stringify(payload), headers: {"Content-Type":"application/json"} })
        .then(r => r.json())
        .then(data => {
          if(data.status === "already_done"){
            fetch("/done").then(r => r.json()).then(done => {
              const name = done.filename ? done.filename.split(/[\\/]/).pop() : "";
              showFinished("audio", name);
            });
          } else {
            if(poller) clearInterval(poller);
            poller = setInterval(updateProgress, 800);
          }
        })
        .catch(() => {
          showError("‚ùå Failed to start audio download.");
          hideSpinner("audio");
          el("cancel-btn").style.display = "none";
        });
    }

    // Start video download (unchanged)
    function startVideo(){
      resetProgressUI();
      showSpinner("video");
      el("video-section").style.display = "block";
      el("audio-section").style.display = "block";
      el("merge-section").style.display = "block";
      el("progress-section").style.display = "block";
      el("cancel-btn").style.display = "inline-block";
      el("reset-btn").style.display = "inline-block";

      const payload = {
        url: getVal("url"),
        video_id: getVal("video") || null,
        audio_id: getVal("audio") || null
      };

      fetch("/download_video", { method:"POST", body: JSON.stringify(payload), headers: {"Content-Type":"application/json"} })
        .then(r => r.json())
        .then(data => {
          if(data.status === "already_done"){
            fetch("/done").then(r => r.json()).then(done => {
              const name = done.filename ? done.filename.split(/[\\/]/).pop() : "";
              showFinished("video", name);
              showFinished("audio", name);
              showFinished("merge", name);
            });
          } else {
            if(poller) clearInterval(poller);
            poller = setInterval(updateProgress, 800);
          }
        })
        .catch(() => {
          showError("‚ùå Failed to start video download.");
          hideSpinner("video");
          el("cancel-btn").style.display = "none";
        });
    }

    function cancelDownload(){
      fetch("/cancel", { method:"POST" }).then(() => {
        clearInterval(poller);
        resetProgressUI();
        hideSpinner("audio");
        hideSpinner("video");
        el("cancel-btn").style.display = "none";
        setText("status","Download cancelled.");
      });
    }

    function updateProgress(){
      fetch("/progress").then(r => r.json()).then(data => {
        if(data.video) {
          el("video-section").style.display = "block";
          updateBar("video", data.video);
        }
        if(data.audio) {
          el("audio-section").style.display = "block";
          updateBar("audio", data.audio);
        }
        if(data.merge) {
          el("merge-section").style.display = "block";
          updateBar("merge", data.merge);
        }

        const audioOnlyDone = data.audio && data.audio.status === "finished" && (!data.video || !data.video.status);
        const videoModeDone = data.merge && data.merge.status === "finished";

        if(audioOnlyDone || videoModeDone){
          clearInterval(poller);
          fetch("/done").then(r => r.json()).then(done => {
            const name = done.filename ? done.filename.split(/[\\/]/).pop() : "";
            setText("complete", `‚úÖ Download complete: ${name}`);
            hideSpinner("audio");
            hideSpinner("video");
            el("cancel-btn").style.display = "none";
          });
        }
      }).catch(err => {
        console.error('progress poll error', err);
      });
    }

    function updateBar(phase, info){
      const percentStr = (info.percent || "0%").toString();
      const match = percentStr.match(/(\d+(\.\d+)?)/);
      const percent = match ? match[1] : "0";
      el(`${phase}-bar`).style.width = `${percent}%`;
      setText(`${phase}-percent`, `${percent}%`);
      setText(`${phase}-eta`, `ETA: ${info.eta || "‚Äî"}`);
      setText(`${phase}-speed`, `Speed: ${info.speed || "‚Äî"}`);
      setText(`${phase}-size`, `Size: ${info.size || "‚Äî"}`);
      setText(`${phase}-status`, `Status: ${info.status || "‚Äî"}`);
    }

    function showFinished(phase, filename){
      el(`${phase}-section`).style.display = "block";
      el(`${phase}-bar`).style.width = "100%";
      setText(`${phase}-percent`, "100%");
      setText(`${phase}-eta`, "Done");
      setText(`${phase}-speed`, "‚Äî");
      setText(`${phase}-size`, "‚Äî");
      setText(`${phase}-status`, "finished");
      if(filename) setText("complete", `‚úÖ Download complete: ${filename}`);
      hideSpinner("audio"); hideSpinner("video");
      el("cancel-btn").style.display = "none";
    }

    function resetUI(){
      clearInterval(poller);
      resetProgressUI();
      hideSpinner("audio"); hideSpinner("video");
      fetch("/reset", { method:"POST" }).then(()=> {
        el("fetched-area").style.display = "none";
        el("progress-section").style.display = "none";
        el("cancel-btn").style.display = "none";
        el("reset-btn").style.display = "none";
        setText("status","üîÑ Reset done. Ready for new fetch.");
        setText("complete","");
        setText("error","");
      });
    }

    function resetProgressUI(){
      ["video","audio","merge"].forEach(p => {
        el(`${p}-bar`).style.width = "0%";
        setText(`${p}-percent`, "0%");
        setText(`${p}-eta`, `ETA: ‚Äî`);
        setText(`${p}-speed`, `Speed: ‚Äî`);
        setText(`${p}-size`, `Size: ‚Äî`);
        setText(`${p}-status`, `Status: ‚Äî`);
        el(`${p}-section`).style.display = "none";
      });
      el("progress-section").style.display = "none";
      el("error").style.display = "none";
      setText("complete","");
    }

    function showError(msg){
      el("error").textContent = msg;
      el("error").style.display = "block";
    }

    function showSpinner(which){
      if(which === "audio"){
        el("audio-btn").disabled = true;
        el("audio-btn").innerHTML = `<span class="spinner"></span>Downloading Audio‚Ä¶`;
      } else {
        el("video-btn").disabled = true;
        el("video-btn").innerHTML = `<span class="spinner"></span>Downloading Video‚Ä¶`;
      }
    }

    function hideSpinner(which){
      if(which === "audio"){
        el("audio-btn").disabled = false;
        el("audio-btn").textContent = "Download Audio";
      } else if(which === "video"){
        el("video-btn").disabled = false;
        el("video-btn").textContent = "Download Video";
      } else {
        el("audio-btn").disabled = false; el("video-btn").disabled = false;
        el("audio-btn").textContent = "Download Audio";
        el("video-btn").textContent = "Download Video";
      }
    }

    // initial
    resetProgressUI();
  </script>
</body>
</html>
